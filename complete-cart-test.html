<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart System Complete Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .button { 
            padding: 10px 20px; 
            margin: 10px 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 5px; 
            font-family: monospace;
            font-size: 12px;
        }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .step-counter { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>üõí Complete Cart System Test</h1>
    <p>This tool will test the entire cart flow from adding items to completing orders.</p>
    
    <div class="test-section">
        <h3>Step 1: Backend Connection Test</h3>
        <button class="button" onclick="testBackendConnection()">Test Backend Connection</button>
        <div id="backend-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Cart Storage Test</h3>
        <button class="button" onclick="testCartStorage()">Test Cart Storage</button>
        <button class="button danger" onclick="clearCartStorage()">Clear Cart Storage</button>
        <div id="storage-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Simulate Cart Operations</h3>
        <button class="button" onclick="simulateAddToCart()">Add Test Items to Cart</button>
        <button class="button" onclick="testCartContext()">Test Cart Context</button>
        <div id="cart-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Frontend Application Test</h3>
        <button class="button success" onclick="openMainApp()">Open Main Application</button>
        <button class="button" onclick="openRestaurantsPage()">Open Restaurants Page</button>
        <button class="button" onclick="openCartPage()">Open Cart Page</button>
        <div id="app-results"></div>
    </div>

    <div class="test-section">
        <h3>Step 5: Order Creation Test</h3>
        <button class="button" onclick="testOrderCreation()">Test Order Creation</button>
        <div id="order-results"></div>
    </div>

    <div class="test-section">
        <h3>Test Results Summary</h3>
        <div id="summary-results"></div>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info', containerId = null) {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<span class="step-counter">[${timestamp}]</span> ${message}`;
            
            if (containerId) {
                document.getElementById(containerId).appendChild(div);
            }
            
            testResults.push({ timestamp, message, type });
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary-results');
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            summary.innerHTML = `
                <div class="result info">
                    <strong>Test Summary:</strong><br>
                    ‚úÖ Success: ${successCount}<br>
                    ‚ùå Errors: ${errorCount}<br>
                    ‚ö†Ô∏è Warnings: ${warningCount}<br>
                    üìä Total Tests: ${testResults.length}
                </div>
            `;
        }

        async function testBackendConnection() {
            log('üîÑ Testing backend connection...', 'info', 'backend-results');
            
            try {
                // Test main backend endpoint
                const response = await fetch('http://localhost:5000/api/restaurants');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Backend connected successfully. Found ${data.length || 0} restaurants.`, 'success', 'backend-results');
                } else {
                    log(`‚ùå Backend responded with error: ${response.status} ${response.statusText}`, 'error', 'backend-results');
                }
            } catch (error) {
                log(`‚ùå Backend connection failed: ${error.message}`, 'error', 'backend-results');
                log('üí° Make sure the backend server is running on localhost:5000', 'warning', 'backend-results');
            }
        }

        function testCartStorage() {
            log('üîÑ Testing localStorage functionality...', 'info', 'storage-results');
            
            try {
                // Test localStorage read/write
                const testData = {
                    testItem: 'test-value',
                    timestamp: Date.now(),
                    items: [
                        { _id: 'test1', name: 'Test Pizza', price: 15.99, quantity: 2 },
                        { _id: 'test2', name: 'Test Burger', price: 12.99, quantity: 1 }
                    ]
                };
                
                localStorage.setItem('cart-test', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('cart-test'));
                
                if (retrieved && retrieved.testItem === 'test-value') {
                    log('‚úÖ localStorage is working correctly', 'success', 'storage-results');
                } else {
                    log('‚ùå localStorage test failed', 'error', 'storage-results');
                }
                
                // Check existing cart data
                const existingCart = localStorage.getItem('cart');
                const existingCartItems = localStorage.getItem('cartItems');
                
                if (existingCart) {
                    const parsed = JSON.parse(existingCart);
                    log(`üì¶ Found existing cart data (cart key): ${parsed.length} items`, 'info', 'storage-results');
                }
                
                if (existingCartItems) {
                    const parsed = JSON.parse(existingCartItems);
                    log(`üì¶ Found existing cart data (cartItems key): ${parsed.length} items`, 'info', 'storage-results');
                }
                
                if (!existingCart && !existingCartItems) {
                    log('üì¶ No existing cart data found', 'info', 'storage-results');
                }
                
                localStorage.removeItem('cart-test');
                
            } catch (error) {
                log(`‚ùå localStorage error: ${error.message}`, 'error', 'storage-results');
            }
        }

        function clearCartStorage() {
            localStorage.removeItem('cart');
            localStorage.removeItem('cartItems');
            localStorage.removeItem('restaurantId');
            log('üßπ Cart storage cleared', 'success', 'storage-results');
        }

        function simulateAddToCart() {
            log('üîÑ Simulating cart operations...', 'info', 'cart-results');
            
            try {
                // Simulate adding items using the same localStorage key as CartContext
                const testItems = [
                    {
                        _id: 'test-item-1',
                        name: 'Margherita Pizza',
                        price: 15.99,
                        quantity: 2,
                        restaurantId: 'test-restaurant-1'
                    },
                    {
                        _id: 'test-item-2',
                        name: 'Caesar Salad',
                        price: 8.99,
                        quantity: 1,
                        restaurantId: 'test-restaurant-1'
                    }
                ];
                
                // Use the same localStorage key as CartContext ('cart')
                localStorage.setItem('cart', JSON.stringify(testItems));
                localStorage.setItem('restaurantId', 'test-restaurant-1');
                
                // Also set cartItems key for backwards compatibility
                localStorage.setItem('cartItems', JSON.stringify(testItems));
                
                log(`‚úÖ Added ${testItems.length} test items to cart`, 'success', 'cart-results');
                log(`üçï Items: ${testItems.map(item => `${item.name} (x${item.quantity})`).join(', ')}`, 'info', 'cart-results');
                  // Calculate total
                const total = testItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                log(`üí∞ Cart total: ‚Çπ${total.toFixed(2)}`, 'info', 'cart-results');
                
                // Trigger storage event to notify React components
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'cart',
                    newValue: JSON.stringify(testItems),
                    url: window.location.href
                }));
                
            } catch (error) {
                log(`‚ùå Failed to simulate cart operations: ${error.message}`, 'error', 'cart-results');
            }
        }

        function testCartContext() {
            log('üîÑ Testing cart context integration...', 'info', 'cart-results');
            
            // Check if React app is running and accessible
            const cartData = localStorage.getItem('cart');
            if (cartData) {
                const items = JSON.parse(cartData);
                log(`‚úÖ Cart context should show ${items.length} items`, 'success', 'cart-results');
                log('üí° Open the main app to verify cart context is working', 'warning', 'cart-results');
            } else {
                log('‚ùå No cart data found for context test', 'error', 'cart-results');
            }
        }

        function openMainApp() {
            const url = 'http://localhost:5173';
            window.open(url, '_blank');
            log(`üöÄ Opened main application: ${url}`, 'success', 'app-results');
            log('üí° Check if cart shows test items and navigate to restaurants', 'info', 'app-results');
        }

        function openRestaurantsPage() {
            const url = 'http://localhost:5173/restaurants';
            window.open(url, '_blank');
            log(`üçΩÔ∏è Opened restaurants page: ${url}`, 'success', 'app-results');
            log('üí° Try adding items from a real restaurant', 'info', 'app-results');
        }

        function openCartPage() {
            const url = 'http://localhost:5173/cart';
            window.open(url, '_blank');
            log(`üõí Opened cart page: ${url}`, 'success', 'app-results');
            log('üí° Verify that test items are displayed correctly', 'info', 'app-results');
        }

        async function testOrderCreation() {
            log('üîÑ Testing order creation...', 'info', 'order-results');
            
            try {
                const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
                
                if (cartItems.length === 0) {
                    log('‚ùå No cart items found. Add items to cart first.', 'error', 'order-results');
                    return;
                }
                
                const orderData = {
                    cartItems: cartItems,
                    customerName: 'Test Customer',
                    customerPhone: '1234567890',
                    customerEmail: 'test@example.com',
                    deliveryType: 'takeout',
                    restaurantId: cartItems[0].restaurantId,
                    totalAmount: cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };
                
                log('üìã Order payload prepared:', 'info', 'order-results');
                log(`<pre>${JSON.stringify(orderData, null, 2)}</pre>`, 'info', 'order-results');
                
                // Test the order creation endpoint
                const response = await fetch('http://localhost:5000/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Order creation test successful!', 'success', 'order-results');
                    log(`üìù Order ID: ${result._id || result.id || 'N/A'}`, 'success', 'order-results');
                } else {
                    const errorData = await response.json();
                    log(`‚ùå Order creation failed: ${response.status} ${response.statusText}`, 'error', 'order-results');
                    log(`Error details: ${JSON.stringify(errorData, null, 2)}`, 'error', 'order-results');
                }
                
            } catch (error) {
                log(`‚ùå Order creation test failed: ${error.message}`, 'error', 'order-results');
            }
        }

        // Auto-run initial tests
        window.onload = function() {
            log('üöÄ Cart System Complete Test loaded', 'success');
            setTimeout(() => {
                testBackendConnection();
                testCartStorage();
            }, 500);
        };
    </script>
</body>
</html>
