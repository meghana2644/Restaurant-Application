<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete User Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .step {
            background-color: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        .token-display {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>üß™ Complete User Flow Test</h1>
    
    <div class="test-section">
        <h2>üìù Step 1: User Registration</h2>
        <div class="form-group">
            <label for="regName">Name:</label>
            <input type="text" id="regName" value="Test User">
        </div>
        <div class="form-group">
            <label for="regEmail">Email:</label>
            <input type="email" id="regEmail" value="testuser@example.com">
        </div>
        <div class="form-group">
            <label for="regPassword">Password:</label>
            <input type="password" id="regPassword" value="password123">
        </div>
        <button onclick="testRegistration()">üöÄ Test Registration</button>
        <div id="registrationResult" class="result" style="display: none;"></div>
        <div id="regToken" class="token-display" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üîê Step 2: User Login</h2>
        <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" value="testuser@example.com">
        </div>
        <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" value="password123">
        </div>
        <button onclick="testLogin()">üîë Test Login</button>
        <div id="loginResult" class="result" style="display: none;"></div>
        <div id="loginToken" class="token-display" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üë§ Step 3: Get User Profile</h2>
        <button onclick="testGetProfile()">üìã Get Profile</button>
        <div id="profileResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üçΩÔ∏è Step 4: Browse Restaurants</h2>
        <button onclick="testGetRestaurants()">üè™ Get Restaurants</button>
        <div id="restaurantsResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìã Step 5: Get Menu Items</h2>
        <div class="form-group">
            <label for="restaurantId">Restaurant ID:</label>
            <input type="text" id="restaurantId" placeholder="Will be filled from restaurant list">
        </div>
        <button onclick="testGetMenuItems()">üìù Get Menu Items</button>
        <div id="menuResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üõí Step 6: Place Order</h2>
        <div class="form-group">
            <label for="orderRestaurantId">Restaurant ID:</label>
            <input type="text" id="orderRestaurantId" placeholder="Will be filled from restaurant list">
        </div>
        <div class="form-group">
            <label for="orderItems">Order Items (JSON):</label>
            <textarea id="orderItems" rows="4" placeholder='[{"menuItemId": "item_id", "quantity": 1}]'></textarea>
        </div>
        <div class="form-group">
            <label for="totalAmount">Total Amount:</label>
            <input type="number" id="totalAmount" value="25.99" step="0.01">
        </div>
        <button onclick="testPlaceOrder()">üõí Place Order</button>
        <div id="orderResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üîß Restaurant Owner Test</h2>
        <div class="step">Test restaurant owner login and order management</div>        <div class="form-group">
            <label for="ownerEmail">Owner Email:</label>
            <input type="email" id="ownerEmail" value="pizza@restaurant.com">
        </div>
        <div class="form-group">
            <label for="ownerPassword">Owner Password:</label>
            <input type="password" id="ownerPassword" value="owner123">
        </div>
        <button onclick="testOwnerLogin()">üîë Owner Login</button>
        <button onclick="testGetOwnerOrders()">üìã Get Orders</button>
        <button onclick="testApproveOrder()">‚úÖ Approve Test Order</button>
        <div id="ownerResult" class="result" style="display: none;"></div>
    </div>

    <script>
        let currentToken = null;
        let ownerToken = null;
        let currentUser = null;
        let testOrderId = null;

        const API_BASE = 'http://localhost:5000/api';

        async function makeRequest(url, options = {}) {
            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    ...(currentToken && { 'Authorization': `Bearer ${currentToken}` }),
                    ...(ownerToken && url.includes('restaurant-owner') && { 'Authorization': `Bearer ${ownerToken}` }),
                    ...options.headers
                },
                ...options
            });
            
            const data = await response.json();
            return { response, data };
        }

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.textContent = JSON.stringify(data, null, 2);
        }

        function showToken(elementId, token) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<strong>Token:</strong> ${token}`;
        }

        async function testRegistration() {
            try {
                const { response, data } = await makeRequest(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('regName').value,
                        email: document.getElementById('regEmail').value,
                        password: document.getElementById('regPassword').value
                    })
                });

                if (response.ok) {
                    currentToken = data.token;
                    currentUser = data.user;
                    showToken('regToken', currentToken);
                    showResult('registrationResult', data);
                    
                    // Auto-fill login form
                    document.getElementById('loginEmail').value = data.user.email;
                } else {
                    showResult('registrationResult', data, true);
                }
            } catch (error) {
                showResult('registrationResult', { error: error.message }, true);
            }
        }

        async function testLogin() {
            try {
                const { response, data } = await makeRequest(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });

                if (response.ok) {
                    currentToken = data.token;
                    currentUser = data.user;
                    showToken('loginToken', currentToken);
                    showResult('loginResult', data);
                } else {
                    showResult('loginResult', data, true);
                }
            } catch (error) {
                showResult('loginResult', { error: error.message }, true);
            }
        }

        async function testGetProfile() {
            try {
                const { response, data } = await makeRequest(`${API_BASE}/auth/me`);

                if (response.ok) {
                    showResult('profileResult', data);
                } else {
                    showResult('profileResult', data, true);
                }
            } catch (error) {
                showResult('profileResult', { error: error.message }, true);
            }
        }

        async function testGetRestaurants() {
            try {
                const { response, data } = await makeRequest(`${API_BASE}/restaurants`);

                if (response.ok) {
                    showResult('restaurantsResult', data);
                    // Auto-fill restaurant ID if restaurants exist
                    if (data.length > 0) {
                        document.getElementById('restaurantId').value = data[0]._id;
                        document.getElementById('orderRestaurantId').value = data[0]._id;
                    }
                } else {
                    showResult('restaurantsResult', data, true);
                }
            } catch (error) {
                showResult('restaurantsResult', { error: error.message }, true);
            }
        }

        async function testGetMenuItems() {
            const restaurantId = document.getElementById('restaurantId').value;
            if (!restaurantId) {
                alert('Please get restaurants first to fill the restaurant ID');
                return;
            }

            try {
                const { response, data } = await makeRequest(`${API_BASE}/restaurants/${restaurantId}/menu`);

                if (response.ok) {
                    showResult('menuResult', data);
                    // Auto-fill order items if menu items exist
                    if (data.length > 0) {
                        const orderItems = [{
                            menuItemId: data[0]._id,
                            quantity: 1
                        }];
                        document.getElementById('orderItems').value = JSON.stringify(orderItems, null, 2);
                    }
                } else {
                    showResult('menuResult', data, true);
                }
            } catch (error) {
                showResult('menuResult', { error: error.message }, true);
            }
        }

        async function testPlaceOrder() {
            const restaurantId = document.getElementById('orderRestaurantId').value;
            const orderItemsText = document.getElementById('orderItems').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);

            if (!restaurantId || !orderItemsText) {
                alert('Please fill all order fields');
                return;
            }

            try {
                const orderItems = JSON.parse(orderItemsText);
                const { response, data } = await makeRequest(`${API_BASE}/orders`, {
                    method: 'POST',
                    body: JSON.stringify({
                        restaurantId,
                        items: orderItems,
                        totalAmount
                    })
                });

                if (response.ok) {
                    testOrderId = data._id;
                    showResult('orderResult', data);
                } else {
                    showResult('orderResult', data, true);
                }
            } catch (error) {
                showResult('orderResult', { error: error.message }, true);
            }
        }

        async function testOwnerLogin() {
            try {
                const { response, data } = await makeRequest(`${API_BASE}/auth/restaurant-owner/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('ownerEmail').value,
                        password: document.getElementById('ownerPassword').value
                    })
                });

                if (response.ok) {
                    ownerToken = data.token;
                    showResult('ownerResult', { message: 'Owner login successful', ...data });
                } else {
                    showResult('ownerResult', data, true);
                }
            } catch (error) {
                showResult('ownerResult', { error: error.message }, true);
            }
        }

        async function testGetOwnerOrders() {
            if (!ownerToken) {
                alert('Please login as restaurant owner first');
                return;
            }

            try {
                const { response, data } = await makeRequest(`${API_BASE}/restaurant-owner/orders`, {
                    headers: { 'Authorization': `Bearer ${ownerToken}` }
                });

                if (response.ok) {
                    showResult('ownerResult', { message: 'Orders retrieved successfully', orders: data });
                } else {
                    showResult('ownerResult', data, true);
                }
            } catch (error) {
                showResult('ownerResult', { error: error.message }, true);
            }
        }

        async function testApproveOrder() {
            if (!ownerToken) {
                alert('Please login as restaurant owner first');
                return;
            }

            if (!testOrderId) {
                alert('Please place an order first');
                return;
            }

            try {
                const { response, data } = await makeRequest(`${API_BASE}/restaurant-owner/orders/${testOrderId}/approve`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${ownerToken}` }
                });

                if (response.ok) {
                    showResult('ownerResult', { message: 'Order approved successfully', ...data });
                } else {
                    showResult('ownerResult', data, true);
                }
            } catch (error) {
                showResult('ownerResult', { error: error.message }, true);
            }
        }

        // Auto-fill owner email if seeded data exists
        window.addEventListener('load', () => {
            console.log('Complete User Flow Test Page Loaded');
            console.log('Test the complete user journey from registration to order approval');
        });
    </script>
</body>
</html>
